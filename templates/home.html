<!DOCTYPE html>
<html>
<head>
	<title>Join Stylesense</title>
	<link rel="stylesheet" href="/static/css/styles.css" type="text/css">
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
</head>

<body>
	<div class="header content">
		<a href="/">Stylesense</a>
	</div>
	<div class="main">
		<div class="content">

			<h2 class="info title">Which outfit is better?</h2>
			<div class="battle_wrap">
				<div class="row" id="photos">
					<div class="col-2-5 pic1_col">
						<img src="http://placehold.it/306x306" id="photo1" onerror="new_round();">
					</div>
					<div class="col-1-5 skip_col">
					vs<a class="skip" href="#">Skip</a>
					</div>
					<div class="col-2-5 pic2_col">
						<img src="http://placehold.it/306x306" id="photo2" onerror="new_round();">
					</div>
				</div>
				<div class="row">
					<div class="col-2-5 user1_col">
					@user1
					</div>
					<div class="col-1-5">
					
					</div>
					<div class="col-2-5 user2_col">
					@user2
					</div>
				</div>
				<div class="row">
					<div class="col-2-5 user1_col">
					22 wins / 11 losses
					</div>
					<div class="col-1-5">
					
					</div>
					<div class="col-2-5 user2_col">
					5 wins / 2 losses
					</div>
				</div>

			</div>
		</div>
	</div>
	<div class="footer">
		<div class="content">
			<p class="brief">Stylesense is a battleground of #ootd pics for the instagram community. <br>Join the fun: <a class="instagram" href="https://api.instagram.com/oauth/authorize/?client_id=77bdd37f87264ebea8c9a3178c9abd20&redirect_uri=http://desolate-woodland-8107.herokuapp.com/igram_oauth_callback&response_type=code"></a></p>
			<p class="leaderboard_g">Who's winning: <span class="leaders">@kimk (42w / 5l), @rihanna (38w / 6l), @miley (22w / 10l)</span></p>
			<p class="copyright">&copy; 2013 Stylesen.se. Handcrafted in Canada by <a href="http://twitter.com/aam1r">@aam1r</a> and <a href="http://twitter.com/sidjha">@sidjha</a>.</p>
		</div>
	</div>

	<script>
    var rounds_played = 0;
    var cur_round, prev_round;

    initialize();

    function Round(player1, player2) {
      this.player1 = player1;
      this.player2 = player2;
      this.winner = null;

      this.set_winner = function(winner) {
        this.winner = winner;
      }

      this.render = function() {
        setup_image($('#photo1'), this.player1);
        setup_image($('#photo2'), this.player2);
        $('#photos').css({'display': 'block'});
      }

      this.clear_ = function() {
        $('#photos').css({'display': 'none'});
      }

      this.save = function(obj) {
        $.ajax({
          url: '/tally_round',
          method: 'POST',
          data: {
            photo1: obj.player1.obj_id,
            photo2: obj.player2.obj_id,
            winner: obj.winner.obj_id
          }
        });
      }
    }

    function Player(player) {
      this.image_url = player.images.low_resolution.url;
      this.obj_id = player.objectId;
    }

    function new_round() {
      $.ajax({
        url: '/new_round',
        method: 'GET',
        success: function(data) {
          var players = $.parseJSON(data);
          var player1 = new Player(players[0]);
          var player2 = new Player(players[1]);
          cur_round = new Round(player1, player2);
          cur_round.render();
        }
      });
    }

    function initialize() {
      $.ajax({
        url: '/new_round',
        method: 'GET',
        success: function(data) {
          var players = $.parseJSON(data);
          console.log("Getting initial data...")
          console.log(players);
          var player1 = new Player(players[0]);
          var player2 = new Player(players[1]);
          cur_round = new Round(player1, player2);
          cur_round.render();
        }
      });
    }

    function setup_image(elem, obj) {
      var url = obj.image_url;
      elem.attr('src', url);
    }

    $('#photo1').on('click', function() {
      cur_round.set_winner(cur_round.player1);
      prev_round = cur_round;
      prev_round.clear_();
      new_round();
      prev_round.save(prev_round);
    });

    $('#photo2').on('click', function() {
      cur_round.set_winner(cur_round.player2);
      prev_round = cur_round;
      prev_round.clear_();
      new_round();
      prev_round.save(prev_round);
    });
    </script>
</body>

</html>